<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>New for Me ‚Äî iNaturalist Lifer Mapper</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{--parchment:#f5f0e8;--ink:#2c2416;--ink-light:#6b5d4f;--moss:#4a7c59;--moss-dark:#3a6347;--moss-pale:#e8f0ea;--amber:#c97d3a;--amber-pale:#fdf3e7;--clay:#b85c3c;--shadow:rgba(44,36,22,0.12);--radius:10px;--panel-max:420px}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'DM Sans',sans-serif;color:var(--ink);background:var(--parchment);height:100dvh;overflow:hidden;-webkit-font-smoothing:antialiased}
#map{position:absolute;inset:0;z-index:1}
.leaflet-control-attribution{font-size:10px!important}
.marker-cluster-small,.marker-cluster-medium,.marker-cluster-large{background:rgba(201,125,58,0.25)!important}
.marker-cluster-small div,.marker-cluster-medium div,.marker-cluster-large div{background:var(--amber)!important;color:#fff!important;font-family:'DM Sans',sans-serif!important;font-weight:600!important}
.obs-marker{width:12px;height:12px;border-radius:50%;border:2px solid #fff;box-shadow:0 1px 4px rgba(0,0,0,0.35)}
.leaflet-popup-content-wrapper{border-radius:12px!important;box-shadow:0 4px 16px rgba(0,0,0,0.15)!important;padding:0!important;overflow:hidden}
.leaflet-popup-content{margin:0!important;width:240px!important}
.obs-popup{display:flex;flex-direction:column}
.obs-popup img{width:100%;height:160px;object-fit:cover;background:#e8e2d8}
.obs-popup .obs-meta{padding:10px 14px 12px}
.obs-popup .obs-common{font-weight:600;font-size:14px;line-height:1.3}
.obs-popup .obs-sci{font-size:12px;font-style:italic;color:var(--ink-light)}
.obs-popup .obs-date{font-size:11px;color:var(--ink-light);margin-top:4px}
.obs-popup .obs-user{font-size:11px;color:var(--moss);margin-top:2px}
.obs-popup .obs-link{display:block;padding:8px 14px;background:var(--moss);color:#fff;text-align:center;text-decoration:none;font-size:13px;font-weight:600;transition:background 0.15s}
.obs-popup .obs-link:hover{background:var(--moss-dark)}
.leaflet-popup-tip{border-top-color:#fff!important}
.top-bar{position:fixed;top:0;left:0;right:0;z-index:1000;padding:12px 16px;display:flex;align-items:center;gap:10px;background:linear-gradient(to bottom,var(--parchment) 60%,transparent);pointer-events:none}
.top-bar>*{pointer-events:auto}
.logo{font-family:'DM Serif Display',serif;font-size:20px;color:var(--ink);white-space:nowrap;text-shadow:0 1px 2px rgba(255,255,255,0.6)}
.logo span{color:var(--moss)}
.pill-btn{display:inline-flex;align-items:center;gap:6px;padding:8px 14px;border-radius:20px;border:1.5px solid var(--ink);background:var(--parchment);font-family:inherit;font-size:13px;font-weight:500;color:var(--ink);cursor:pointer;transition:all 0.15s;box-shadow:0 2px 6px var(--shadow)}
.pill-btn:hover{background:var(--ink);color:var(--parchment)}
.pill-btn svg{width:16px;height:16px;flex-shrink:0}
.spacer{flex:1}
.sheet-backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.25);z-index:1500}
.sheet-backdrop.open{display:block}
.sheet{position:fixed;bottom:0;left:0;right:0;z-index:2000;background:var(--parchment);border-radius:20px 20px 0 0;box-shadow:0 -4px 24px var(--shadow);transform:translateY(100%);transition:transform 0.3s cubic-bezier(0.22,1,0.36,1);max-height:88dvh;display:flex;flex-direction:column}
.sheet.open{transform:translateY(0)}
.sheet-handle{width:36px;height:4px;background:#ccc;border-radius:2px;margin:10px auto 6px;flex-shrink:0}
.sheet-header{padding:4px 20px 14px;border-bottom:1px solid rgba(0,0,0,0.08);flex-shrink:0}
.sheet-header h2{font-family:'DM Serif Display',serif;font-size:22px;color:var(--ink)}
.sheet-header p{font-size:13px;color:var(--ink-light);margin-top:2px}
.sheet-body{padding:16px 20px 24px;overflow-y:auto;flex:1}
.field{margin-bottom:16px}
.field label{display:block;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:var(--ink-light);margin-bottom:6px}
.field input,.field select{width:100%;padding:10px 14px;border:1.5px solid #d4cdc1;border-radius:var(--radius);font-family:inherit;font-size:15px;color:var(--ink);background:#fff;outline:none;transition:border-color 0.15s;-webkit-appearance:none;appearance:none}
.field select{background:#fff url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath d='M2 4l4 4 4-4' fill='none' stroke='%236b5d4f' stroke-width='1.5'/%3E%3C/svg%3E") no-repeat right 14px center;padding-right:36px}
.field input:focus,.field select:focus{border-color:var(--moss)}
.field input::placeholder{color:#b8b0a4}
.autocomplete-wrap{position:relative}
.autocomplete-list{position:absolute;top:100%;left:0;right:0;background:#fff;border:1.5px solid #d4cdc1;border-top:none;border-radius:0 0 var(--radius) var(--radius);max-height:200px;overflow-y:auto;z-index:10;display:none}
.autocomplete-list.visible{display:block}
.ac-item{padding:10px 14px;cursor:pointer;font-size:14px;border-bottom:1px solid #f0ece5;display:flex;align-items:center;gap:8px}
.ac-item:hover{background:var(--moss-pale)}
.ac-item img{width:28px;height:28px;border-radius:6px;object-fit:cover;flex-shrink:0}
.ac-item .ac-name{font-weight:500}
.ac-item .ac-sub{font-size:12px;color:var(--ink-light)}
.row{display:flex;gap:10px}
.row>.field{flex:1}
.mode-toggle{display:flex;border:1.5px solid #d4cdc1;border-radius:var(--radius);overflow:hidden;margin-bottom:16px}
.mode-toggle button{flex:1;padding:10px;border:none;background:#fff;font-family:inherit;font-size:13px;font-weight:500;color:var(--ink-light);cursor:pointer;transition:all 0.15s}
.mode-toggle button.active{background:var(--moss);color:#fff}
.btn-go{width:100%;padding:14px;border-radius:var(--radius);border:none;background:var(--moss);color:#fff;font-family:inherit;font-size:15px;font-weight:600;cursor:pointer;transition:background 0.15s}
.btn-go:hover{background:var(--moss-dark)}
.btn-go:disabled{opacity:0.5;cursor:not-allowed}
.helper-text{font-size:12px;color:var(--ink-light);margin:-10px 0 16px}
.loc-btn{display:inline-flex;align-items:center;gap:6px;padding:8px 14px;border-radius:20px;border:1.5px solid #d4cdc1;background:#fff;font-family:inherit;font-size:12px;font-weight:500;color:var(--ink);cursor:pointer;transition:all 0.15s;margin-bottom:16px}
.loc-btn:hover{border-color:var(--moss);color:var(--moss)}
.loc-btn svg{width:14px;height:14px}
.badge{display:flex;align-items:center;gap:8px;padding:10px 14px;border-radius:var(--radius);margin-bottom:16px;font-size:14px;flex-wrap:wrap}
.badge-place{background:var(--moss-pale)}
.badge-taxon{background:var(--amber-pale)}
.badge img{width:28px;height:28px;border-radius:6px;object-fit:cover}
.badge .badge-close{margin-left:auto;background:none;border:none;cursor:pointer;font-size:16px;color:var(--ink-light);padding:0 2px}
.badge .badge-close:hover{color:var(--ink)}
.nearby-section{margin-bottom:16px}
.nearby-section .section-label{font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:var(--ink-light);margin-bottom:8px;display:flex;align-items:center;gap:6px}
.nearby-chips{display:flex;flex-wrap:wrap;gap:6px;max-height:170px;overflow-y:auto;padding-right:4px}
.nearby-chip{display:inline-flex;align-items:center;gap:4px;padding:7px 12px;border-radius:16px;border:1.5px solid #d4cdc1;background:#fff;font-family:inherit;font-size:12px;font-weight:500;color:var(--ink);cursor:pointer;transition:all 0.15s;white-space:nowrap;max-width:100%;overflow:hidden;text-overflow:ellipsis}
.nearby-chip:hover{border-color:var(--moss);color:var(--moss);background:var(--moss-pale)}
.nearby-chip .chip-icon{font-size:13px;flex-shrink:0}
.nearby-chip .chip-type{font-size:10px;color:var(--ink-light);margin-left:2px}
.nearby-loading{font-size:12px;color:var(--ink-light);padding:4px 0;font-style:italic}

/* Taxa browser overlay */
.taxa-overlay{position:fixed;inset:0;z-index:2500;background:var(--parchment);display:none;flex-direction:column;overflow:hidden}
.taxa-overlay.open{display:flex}
.taxa-header{padding:16px 20px 12px;flex-shrink:0;display:flex;align-items:center;gap:10px}
.taxa-header .taxa-back{background:none;border:none;font-size:24px;color:var(--moss);cursor:pointer;padding:4px 8px 4px 0;font-family:inherit;display:none}
.taxa-header .taxa-back.visible{display:block}
.taxa-header-text h1{font-family:'DM Serif Display',serif;font-size:24px;color:var(--ink);margin:0;line-height:1.2}
.taxa-header-text p{font-size:13px;color:var(--ink-light);margin:2px 0 0}
.taxa-body{flex:1;overflow-y:auto;padding:0 16px 32px}
.taxa-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.taxa-tile{position:relative;overflow:hidden;aspect-ratio:1/0.85;border-radius:16px;border:none;cursor:pointer;display:flex;flex-direction:column;justify-content:flex-end;padding:14px;transition:transform 0.15s,box-shadow 0.15s;box-shadow:0 3px 12px rgba(0,0,0,0.15);font-family:inherit;text-align:left}
.taxa-tile:hover{transform:scale(1.03);box-shadow:0 6px 20px rgba(0,0,0,0.2)}
.taxa-tile .tile-glow{position:absolute;inset:0;background:radial-gradient(circle at 60% 30%,rgba(255,255,255,0.12) 0%,transparent 70%)}
.taxa-tile .tile-emoji{font-size:36px;line-height:1;margin-bottom:6px;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3))}
.taxa-tile .tile-img{position:absolute;inset:0;object-fit:cover;width:100%;height:100%;opacity:0.35;transition:opacity 0.3s}
.taxa-tile:hover .tile-img{opacity:0.5}
.taxa-tile .tile-label{font-size:17px;font-weight:600;color:#fff;text-shadow:0 1px 4px rgba(0,0,0,0.4);letter-spacing:0.2;position:relative}
.taxa-tile .tile-arrow{position:absolute;top:12px;right:14px;font-size:16px;color:rgba(255,255,255,0.5)}
.taxa-skip{display:block;width:100%;margin:16px 0 4px;padding:12px 16px;border-radius:12px;border:1.5px dashed #d4cdc1;background:transparent;font-family:inherit;font-size:14px;font-weight:500;color:var(--ink-light);cursor:pointer;transition:all 0.15s}
.taxa-skip:hover{border-color:var(--moss);color:var(--moss)}
.taxa-sub-list{display:flex;flex-direction:column;gap:8px}
.taxa-sub{display:flex;align-items:center;gap:14px;padding:14px 16px;border-radius:14px;border:1.5px solid #e8e2d8;background:#fff;cursor:pointer;font-family:inherit;text-align:left;transition:all 0.15s}
.taxa-sub:hover{border-color:var(--moss);background:var(--moss-pale)}
.taxa-sub.primary{background:linear-gradient(135deg,var(--moss) 0%,var(--moss-dark) 100%);border-color:transparent}
.taxa-sub.primary:hover{opacity:0.9;background:linear-gradient(135deg,var(--moss) 0%,var(--moss-dark) 100%)}
.taxa-sub .sub-icon{width:48px;height:48px;border-radius:12px;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:22px}
.taxa-sub.primary .sub-icon{background:rgba(255,255,255,0.15)}
.taxa-sub:not(.primary) .sub-icon{background:#f5f0e8}
.taxa-sub .sub-label{font-size:15px;font-weight:600}
.taxa-sub.primary .sub-label{color:#fff}
.taxa-sub .sub-desc{font-size:12px;margin-top:1px}
.taxa-sub.primary .sub-desc{color:rgba(255,255,255,0.7)}
.taxa-sub:not(.primary) .sub-desc{color:var(--ink-light)}
.taxa-sub .sub-arrow{margin-left:auto;font-size:18px}
.taxa-sub.primary .sub-arrow{color:rgba(255,255,255,0.5)}
.taxa-sub:not(.primary) .sub-arrow{color:#ccc}
.browse-taxon-btn{display:inline-flex;align-items:center;gap:6px;padding:8px 14px;border-radius:20px;border:1.5px solid #d4cdc1;background:#fff;font-family:inherit;font-size:12px;font-weight:500;color:var(--ink);cursor:pointer;transition:all 0.15s;margin-bottom:8px}
.browse-taxon-btn:hover{border-color:var(--moss);color:var(--moss)}

/* Results bar */
.results-bar{position:fixed;bottom:0;left:0;right:0;z-index:1200;display:none}
.results-bar.visible{display:flex;flex-direction:column}
.results-summary{display:flex;align-items:center;gap:10px;padding:14px 20px;background:var(--ink);color:var(--parchment);cursor:pointer;user-select:none;position:relative}
.results-summary .count{font-family:'DM Serif Display',serif;font-size:28px;color:var(--amber);line-height:1}
.results-summary .label{font-size:13px;line-height:1.3}
.results-summary .chevron{margin-left:auto;transition:transform 0.2s;font-size:18px;opacity:0.6}
.results-summary .chevron.up{transform:rotate(180deg)}
.close-results{position:absolute;top:8px;right:12px;background:none;border:none;color:var(--parchment);font-size:18px;cursor:pointer;opacity:0.4;padding:4px}
.close-results:hover{opacity:1}

/* Season filter strip */
.results-filters{display:flex;align-items:center;gap:8px;padding:8px 20px;background:#fff;border-top:2px solid var(--amber);border-bottom:1px solid rgba(0,0,0,0.06)}
.season-toggle{display:inline-flex;align-items:center;gap:5px;padding:5px 12px;border-radius:14px;border:1.5px solid #d4cdc1;background:#fff;font-family:inherit;font-size:12px;font-weight:500;color:var(--ink-light);cursor:pointer;transition:all 0.15s;white-space:nowrap}
.season-toggle:hover{border-color:var(--moss)}
.season-toggle.active{background:var(--moss);color:#fff;border-color:var(--moss)}
.season-toggle .dot{width:7px;height:7px;border-radius:50%;background:#aaa;transition:background 0.15s}
.season-toggle.active .dot{background:#7dff7d}
.filter-info{font-size:11px;color:var(--ink-light);margin-left:auto}

.results-list{background:var(--parchment);max-height:55dvh;overflow-y:auto;display:none}
.results-list.expanded{display:block}

/* Species card */
.species-card{display:flex;align-items:flex-start;gap:12px;padding:12px 20px;border-bottom:1px solid rgba(0,0,0,0.06);cursor:pointer;transition:background 0.1s;text-decoration:none;color:inherit}
.species-card:hover{background:var(--amber-pale)}
.species-card.off-season{opacity:0.45}
.species-card img{width:44px;height:44px;border-radius:8px;object-fit:cover;flex-shrink:0;background:#e8e2d8;margin-top:2px}
.species-card .placeholder-thumb{width:44px;height:44px;border-radius:8px;background:#e8e2d8;flex-shrink:0;display:flex;align-items:center;justify-content:center;font-size:20px;margin-top:2px}
.species-info{flex:1;min-width:0}
.species-info .common{font-weight:600;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.species-info .scientific{font-size:12px;font-style:italic;color:var(--ink-light);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.species-info .meta-row{display:flex;align-items:center;gap:6px;margin-top:2px;flex-wrap:wrap}
.species-info .obs-count{font-size:11px;color:var(--moss);font-weight:500}
.season-badge{display:inline-flex;align-items:center;gap:3px;font-size:10px;font-weight:600;padding:1px 7px;border-radius:8px;white-space:nowrap}
.season-badge.in{background:#ddf5dd;color:#2d7a2d}
.season-badge.off{background:#f5e5dd;color:#a05a30}
.season-badge.unknown{background:#eee;color:#999}

/* Sparkline */
.sparkline-wrap{margin-top:4px;display:flex;align-items:flex-end;gap:0}
.sparkline-wrap svg{display:block}
.sparkline-months{display:flex;margin-top:1px}
.sparkline-months span{font-size:7px;color:var(--ink-light);text-align:center;line-height:1}
.sparkline-months span.now{color:var(--moss);font-weight:700}

.species-card .fly-to{flex-shrink:0;width:28px;height:28px;border-radius:50%;background:var(--moss-pale);display:flex;align-items:center;justify-content:center;font-size:14px;transition:background 0.15s;margin-top:2px}
.species-card:hover .fly-to{background:var(--moss);color:#fff}

/* Loading */
.loading-overlay{display:none;position:fixed;inset:0;z-index:3000;background:rgba(245,240,232,0.88);flex-direction:column;align-items:center;justify-content:center;gap:16px}
.loading-overlay.visible{display:flex}
.spinner{width:40px;height:40px;border:3px solid #d4cdc1;border-top-color:var(--moss);border-radius:50%;animation:spin 0.8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{font-size:14px;color:var(--ink-light);text-align:center;max-width:260px;line-height:1.4}
.tap-hint{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);z-index:1100;background:var(--ink);color:var(--parchment);padding:10px 18px;border-radius:20px;font-size:13px;font-weight:500;display:none;box-shadow:0 4px 12px rgba(0,0,0,0.2);white-space:nowrap}
.tap-hint.visible{display:block}
.map-badge{position:fixed;top:60px;left:16px;z-index:1000;background:var(--ink);color:var(--parchment);padding:6px 14px;border-radius:16px;font-size:12px;font-weight:500;display:none;box-shadow:0 2px 8px rgba(0,0,0,0.2)}
.map-badge.visible{display:block}
@media(min-width:640px){
  .sheet{left:auto;right:16px;bottom:16px;width:var(--panel-max);border-radius:16px;max-height:calc(100dvh - 32px)}
  .results-bar{left:auto;right:16px;bottom:16px;width:var(--panel-max);border-radius:16px;overflow:hidden}
}
</style>
</head>
<body>
<div id="map"></div>
<div class="map-badge" id="mapBadge"></div>
<div class="top-bar">
  <div class="logo">New for <span>Me</span></div>
  <div class="spacer"></div>
  <button class="pill-btn" onclick="openSheet()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 21l-6-6m2-5a7 7 0 1 1-14 0 7 7 0 0 1 14 0z"/></svg>
    Search
  </button>
</div>
<div class="sheet-backdrop" id="sheetBackdrop" onclick="closeSheet()"></div>
<div class="sheet" id="sheet">
  <div class="sheet-handle"></div>
  <div class="sheet-header"><h2>Find New Species</h2><p>Compare your life list against an area</p></div>
  <div class="sheet-body">
    <div class="field"><label>iNaturalist Username</label><input type="text" id="username" placeholder="e.g. kueda" autocapitalize="none" autocorrect="off" spellcheck="false"></div>
    <label style="display:block;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:var(--ink-light);margin-bottom:6px;">Area Selection</label>
    <div class="mode-toggle">
      <button class="active" data-mode="radius" onclick="setMode('radius',this)">üìç Radius</button>
      <button data-mode="place" onclick="setMode('place',this)">üó∫ iNat Place</button>
    </div>
    <div id="nearbySection" class="nearby-section" style="display:none;">
      <div class="section-label">üìå Nearby iNat places</div>
      <div class="nearby-chips" id="nearbyChips"></div>
    </div>
    <div id="radiusFields">
      <div class="row">
        <div class="field"><label>Lat</label><input type="number" id="lat" step="any" placeholder="35.78"></div>
        <div class="field"><label>Lng</label><input type="number" id="lng" step="any" placeholder="-78.64"></div>
      </div>
      <div class="field"><label>Radius (km)</label><input type="number" id="radius" value="10" min="1" max="100"></div>
      <p class="helper-text">Tap the map to set coordinates, or:</p>
      <button class="loc-btn" onclick="useMyLocation()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="4"/><path d="M12 2v4m0 12v4M2 12h4m12 0h4"/></svg> Use my location</button>
    </div>
    <div id="placeFields" style="display:none;">
      <div class="field"><label>Search iNaturalist Places</label>
        <div class="autocomplete-wrap"><input type="text" id="placeSearch" placeholder="e.g. Quabbin Reservoir, Mt Tom‚Ä¶"><div class="autocomplete-list" id="placeResults"></div></div>
      </div>
    </div>
    <div id="selectedPlace" style="display:none;"></div>
    <label style="display:block;font-size:12px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;color:var(--ink-light);margin-bottom:6px;">Focus Taxon</label>
    <button class="browse-taxon-btn" onclick="closeSheet();openTaxaBrowser()">üîé Browse &amp; change group</button>
    <div id="selectedTaxon" style="display:none;"></div>
    <div class="field"><label>Or search taxa directly</label>
      <div class="autocomplete-wrap"><input type="text" id="taxonSearch" placeholder="e.g. Odonata, Quercus‚Ä¶"><div class="autocomplete-list" id="taxonResults"></div></div>
    </div>
    <div class="field"><label>Observed Within</label>
      <select id="timeFilter">
        <option value="">Any time</option>
        <option value="14">Last 2 weeks</option>
        <option value="30">Last month</option>
        <option value="90">Last 3 months</option>
        <option value="365" selected>Last year</option>
      </select>
    </div>
    <button class="btn-go" onclick="runSearch()">Find what's new for me</button>
  </div>
</div>
<div class="tap-hint" id="tapHint">Tap the map to set your search center</div>
<div class="loading-overlay" id="loading"><div class="spinner"></div><div class="loading-text" id="loadingText">Fetching your life list‚Ä¶</div></div>
<div class="results-bar" id="resultsBar">
  <div class="results-summary" onclick="toggleResults()">
    <div class="count" id="resultCount">0</div>
    <div class="label" id="resultLabel">species new for you</div>
    <div class="chevron" id="chevron">‚ñ≤</div>
    <button class="close-results" onclick="event.stopPropagation();clearResults()">‚úï</button>
  </div>
  <div class="results-filters" id="resultsFilters" style="display:none;">
    <button class="season-toggle active" id="seasonToggle" onclick="toggleSeason()"><span class="dot"></span> In season</button>
    <span class="filter-info" id="filterInfo"></span>
  </div>
  <div class="results-list" id="resultsList"></div>
</div>

<!-- Taxa Browser Overlay -->
<div class="taxa-overlay" id="taxaBrowser">
  <div class="taxa-header">
    <button class="taxa-back" id="taxaBack" onclick="taxaBrowserBack()">‚Äπ</button>
    <div class="taxa-header-text">
      <h1 id="taxaTitle">What are you<br>looking for?</h1>
      <p id="taxaSubtitle">Pick a group to find species new for you</p>
    </div>
  </div>
  <div class="taxa-body" id="taxaBody"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
const TREES_WORKER="https://inat-trees-worker.intrinsic3141.workers.dev";
const INAT_PROXY="https://inat-api-proxy.intrinsic3141.workers.dev";
const LIFE_TAXON_ID=48460;
const MONTH_LABELS=["J","F","M","A","M","J","J","A","S","O","N","D"];
const CUR_MONTH=new Date().getMonth(); // 0-11

let map,searchCircle,placeLayer,obsCluster;
let mode="radius";
let selectedPlaceId=null,selectedPlaceName="";
let selectedTaxonId=null,selectedTaxonName="";
let newForMeSpecies=[];
let obsByTaxon=new Map();
let allFetchedObs=[];
let seasonMap=new Map(); // taxon_id ‚Üí [12 month counts]
let inSeasonSet=new Set();
let seasonFilterOn=true;

// ‚îÄ‚îÄ TAXA BROWSER DATA ‚îÄ‚îÄ
const TAXA_GROUPS = [
  { id:"birds", label:"Birds", emoji:"üê¶", taxonId:3, bg:"linear-gradient(135deg,#5b8c6e,#3a6347)", img:"" },
  { id:"plants", label:"Plants", emoji:"üåø", taxonId:47126, bg:"linear-gradient(135deg,#6a9f4d,#3a6e28)", img:"" },
  { id:"fungi", label:"Fungi", emoji:"üçÑ", taxonId:47170, bg:"linear-gradient(135deg,#8b5e3c,#5a3420)", img:"" },
  { id:"insects", label:"Insects", emoji:"ü™≤", taxonId:47158, bg:"linear-gradient(135deg,#b8943a,#7a6218)", img:"" },
  { id:"mammals", label:"Mammals", emoji:"ü¶ä", taxonId:40151, bg:"linear-gradient(135deg,#7a6b5a,#4a3c2e)", img:"" },
  { id:"reptiles", label:"Reptiles", emoji:"ü¶é", taxonId:26036, bg:"linear-gradient(135deg,#6b8a3e,#3f5a1e)", img:"" },
  { id:"amphibians", label:"Amphibians", emoji:"üê∏", taxonId:20978, bg:"linear-gradient(135deg,#3a8a7a,#1e5a4a)", img:"" },
  { id:"arachnids", label:"Arachnids", emoji:"üï∑Ô∏è", taxonId:47119, bg:"linear-gradient(135deg,#6a4a7a,#3e2a4e)", img:"" },
];
const TAXA_SUBS = {
  birds: [
    { label:"All Birds", emoji:"üê¶", desc:"Everything with feathers", taxonId:3 },
    { label:"Songbirds", emoji:"üê§", desc:"Warblers, sparrows, finches", taxonId:7251 },
    { label:"Raptors", emoji:"ü¶Ö", desc:"Hawks, eagles, falcons", taxonId:71261 },
    { label:"Owls", emoji:"ü¶â", desc:"Strigiformes", taxonId:19350 },
    { label:"Waterbirds", emoji:"ü¶Ü", desc:"Ducks, herons, geese", taxonId:6888 },
    { label:"Shorebirds", emoji:"ü™ø", desc:"Plovers, sandpipers", taxonId:67561 },
    { label:"Woodpeckers", emoji:"ü™∂", desc:"Piciformes", taxonId:18236 },
    { label:"Hummingbirds", emoji:"üíö", desc:"Trochilidae", taxonId:6040 },
  ],
  plants: [
    { label:"All Plants", emoji:"üåø", desc:"The full plant kingdom", taxonId:47126 },
    { label:"Flowering Plants", emoji:"üå∏", desc:"Angiosperms", taxonId:47125 },
    { label:"Ferns & Allies", emoji:"üåø", desc:"Polypodiopsida", taxonId:241944 },
    { label:"Conifers", emoji:"üå≤", desc:"Pinopsida", taxonId:136329 },
    { label:"Grasses & Sedges", emoji:"üåæ", desc:"Poales", taxonId:47163 },
    { label:"Orchids", emoji:"ü™ª", desc:"Orchidaceae", taxonId:47217 },
    { label:"Mosses", emoji:"üü¢", desc:"Bryophytes & liverworts", taxonId:311249 },
  ],
  fungi: [
    { label:"All Fungi", emoji:"üçÑ", desc:"The fungal kingdom", taxonId:47170 },
    { label:"Mushrooms", emoji:"üçÑ", desc:"Agaricomycetes", taxonId:47169 },
    { label:"Lichens", emoji:"ü™®", desc:"Lichenized fungi", taxonId:54743 },
    { label:"Slime Molds", emoji:"ü´†", desc:"Mycetozoa", taxonId:47685 },
  ],
  insects: [
    { label:"All Insects", emoji:"ü™≤", desc:"Six-legged arthropods", taxonId:47158 },
    { label:"Butterflies & Moths", emoji:"ü¶ã", desc:"Lepidoptera", taxonId:47157 },
    { label:"Dragonflies", emoji:"‚ú®", desc:"Odonata", taxonId:47792 },
    { label:"Beetles", emoji:"ü™≤", desc:"Coleoptera", taxonId:47208 },
    { label:"Bees, Wasps & Ants", emoji:"üêù", desc:"Hymenoptera", taxonId:47201 },
    { label:"Flies", emoji:"ü™∞", desc:"Diptera", taxonId:47822 },
    { label:"True Bugs", emoji:"üêõ", desc:"Hemiptera", taxonId:47744 },
  ],
  mammals: [
    { label:"All Mammals", emoji:"ü¶ä", desc:"Warm-blooded & furry", taxonId:40151 },
    { label:"Carnivores", emoji:"üê∫", desc:"Carnivora", taxonId:40153 },
    { label:"Rodents & Rabbits", emoji:"üêøÔ∏è", desc:"Rodentia & Lagomorpha", taxonId:[43698,43094] },
    { label:"Bats", emoji:"ü¶á", desc:"Chiroptera", taxonId:40268 },
    { label:"Hoofed Animals", emoji:"ü¶å", desc:"Artiodactyla", taxonId:40498 },
    { label:"Marine Mammals", emoji:"üêã", desc:"Whales, dolphins, seals", taxonId:[152871,848317] },
  ],
  reptiles: [
    { label:"All Reptiles", emoji:"ü¶é", desc:"Scaled & cold-blooded", taxonId:26036 },
    { label:"Snakes", emoji:"üêç", desc:"Serpentes", taxonId:85553 },
    { label:"Turtles", emoji:"üê¢", desc:"Testudines", taxonId:39532 },
    { label:"Lizards", emoji:"ü¶é", desc:"Lacertilia", taxonId:85604 },
    { label:"Crocodilians", emoji:"üêä", desc:"Crocodylia", taxonId:40481 },
  ],
  amphibians: [
    { label:"All Amphibians", emoji:"üê∏", desc:"Between land & water", taxonId:20978 },
    { label:"Frogs & Toads", emoji:"üê∏", desc:"Anura", taxonId:20979 },
    { label:"Salamanders & Newts", emoji:"üî•", desc:"Caudata", taxonId:26790 },
  ],
  arachnids: [
    { label:"All Arachnids", emoji:"üï∑Ô∏è", desc:"Eight-legged arthropods", taxonId:47119 },
    { label:"Spiders", emoji:"üï∏Ô∏è", desc:"Araneae", taxonId:47118 },
    { label:"Ticks & Mites", emoji:"üî¥", desc:"Acari", taxonId:83188 },
    { label:"Harvestmen", emoji:"ü¶ø", desc:"Opiliones", taxonId:47367 },
  ],
};

let taxaBrowserGroup = null; // currently viewing subcategories of this group

function openTaxaBrowser() {
  taxaBrowserGroup = null;
  renderTaxaGroups();
  document.getElementById("taxaBrowser").classList.add("open");
}
function closeTaxaBrowser() {
  document.getElementById("taxaBrowser").classList.remove("open");
}
function taxaBrowserBack() {
  if (taxaBrowserGroup) {
    taxaBrowserGroup = null;
    renderTaxaGroups();
  }
}

function renderTaxaGroups() {
  document.getElementById("taxaTitle").innerHTML = "What are you<br>looking for?";
  document.getElementById("taxaSubtitle").textContent = "Pick a group to find species new for you";
  document.getElementById("taxaBack").classList.remove("visible");
  const body = document.getElementById("taxaBody");
  body.innerHTML = "";

  // Skip button
  const skip = document.createElement("button");
  skip.className = "taxa-skip";
  skip.textContent = "üîç Search all life ‚Äî skip to map";
  skip.onclick = () => {
    applyTaxonFromBrowser(LIFE_TAXON_ID, "All Life", "üåç");
  };
  body.appendChild(skip);

  // Grid
  const grid = document.createElement("div");
  grid.className = "taxa-grid";
  for (const g of TAXA_GROUPS) {
    const tile = document.createElement("button");
    tile.className = "taxa-tile";
    tile.style.background = g.bg;
    tile.innerHTML = `
      ${g.img ? `<img class="tile-img" src="${g.img}" alt="${g.label}">` : ""}
      <div class="tile-glow"></div>
      <span class="tile-emoji">${g.emoji}</span>
      <span class="tile-label">${g.label}</span>
      <span class="tile-arrow">‚Ä∫</span>`;
    tile.onclick = () => {
      taxaBrowserGroup = g.id;
      renderTaxaSubs(g);
    };
    grid.appendChild(tile);
  }
  body.appendChild(grid);
}

function renderTaxaSubs(group) {
  document.getElementById("taxaTitle").textContent = `${group.emoji} ${group.label}`;
  document.getElementById("taxaSubtitle").textContent = "Choose a focus or search all";
  document.getElementById("taxaBack").classList.add("visible");
  const body = document.getElementById("taxaBody");
  body.innerHTML = "";
  body.scrollTop = 0;

  const list = document.createElement("div");
  list.className = "taxa-sub-list";
  const subs = TAXA_SUBS[group.id] || [];
  subs.forEach((s, i) => {
    const btn = document.createElement("button");
    btn.className = "taxa-sub" + (i === 0 ? " primary" : "");
    btn.innerHTML = `
      <div class="sub-icon">${s.emoji}</div>
      <div style="flex:1;min-width:0">
        <div class="sub-label">${s.label}</div>
        <div class="sub-desc">${s.desc}</div>
      </div>
      <span class="sub-arrow">‚Ä∫</span>`;
    btn.onclick = () => {
      applyTaxonFromBrowser(s.taxonId, s.label, s.emoji);
    };
    list.appendChild(btn);
  });
  body.appendChild(list);
}

function applyTaxonFromBrowser(taxonId, name, emoji) {
  // Save to localStorage
  try {
    localStorage.setItem("nfm_taxon", JSON.stringify({ id: taxonId, name, emoji }));
  } catch(e) {}

  // Apply to search state ‚Äî taxonId can be number or array
  if (taxonId === LIFE_TAXON_ID) {
    selectedTaxonId = null;
    selectedTaxonName = "";
  } else {
    selectedTaxonId = taxonId; // number or array
    selectedTaxonName = name;
  }

  // Update the sheet's taxon display
  updateTaxonDisplay(taxonId, name, emoji);

  closeTaxaBrowser();
  openSheet();
}

function updateTaxonDisplay(taxonId, name, emoji) {
  const el = document.getElementById("selectedTaxon");
  if (taxonId === LIFE_TAXON_ID) {
    el.style.display = "flex";
    el.className = "badge badge-taxon";
    el.innerHTML = `<span>üåç All Life</span><button class="badge-close" onclick="openTaxaBrowser()" title="Change">‚úé</button>`;
  } else {
    el.style.display = "flex";
    el.className = "badge badge-taxon";
    el.innerHTML = `<span>${emoji} ${name}</span><button class="badge-close" onclick="openTaxaBrowser()" title="Change">‚úé</button>`;
  }
}

function loadSavedTaxon() {
  try {
    const saved = localStorage.getItem("nfm_taxon");
    if (saved) {
      const t = JSON.parse(saved);
      if (t.id === LIFE_TAXON_ID) {
        selectedTaxonId = null;
        selectedTaxonName = "";
      } else {
        selectedTaxonId = t.id;
        selectedTaxonName = t.name;
      }
      updateTaxonDisplay(t.id, t.name, t.emoji);
      return true;
    }
  } catch(e) {}
  return false;
}

// ‚îÄ‚îÄ helpers ‚îÄ‚îÄ
async function inatGet(ep,params={}){
  const qs=new URLSearchParams(params).toString();
  const r=await fetch(`${INAT_PROXY}/v1${ep}${qs?"?"+qs:""}`);
  if(!r.ok) throw new Error(`iNat API ${r.status}`);
  return r.json();
}
function getDateFilter(){const d=document.getElementById("timeFilter").value;if(!d)return null;const t=new Date();t.setDate(t.getDate()-parseInt(d));return t.toISOString().slice(0,10)}

async function fetchAreaSpeciesCounts(p,cb){
  const res=[];let pg=1,tot=Infinity;
  while(res.length<tot&&pg<=20){
    const d=await inatGet("/observations/species_counts",{...p,per_page:500,page:pg});
    tot=d.total_results;res.push(...(d.results||[]));
    if(cb)cb(res.length,tot);if((d.results||[]).length<500)break;pg++;
  }
  return{total_results:tot,results:res};
}
async function fetchUserSpeciesIds(u,tid){
  const r=await fetch(`${TREES_WORKER}/build-taxonomy`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:u,taxonId:tid})});
  if(!r.ok){const e=await r.json().catch(()=>({}));throw new Error(e.error||`Worker ${r.status}`)}
  return(await r.json()).speciesTaxonIds||[];
}
async function fetchObservationsForTaxa(taxonIds,areaP,d1,cb){
  const allObs=[];const chunks=[];
  for(let i=0;i<taxonIds.length;i+=80)chunks.push(taxonIds.slice(i,i+80));
  for(let ci=0;ci<chunks.length;ci++){
    let pg=1;while(pg<=3){
      const p={...areaP,taxon_id:chunks[ci].join(","),quality_grade:"research,needs_id",photos:"true",per_page:200,page:pg,order_by:"observed_on",order:"desc"};
      if(d1)p.d1=d1;
      const d=await inatGet("/observations",p);
      for(const obs of(d.results||[])){
        if(!obs.location)continue;const[lat,lng]=obs.location.split(",").map(Number);
        if(isNaN(lat)||isNaN(lng))continue;
        allObs.push({id:obs.id,lat,lng,taxon_id:obs.taxon?.id,common_name:obs.taxon?.preferred_common_name||obs.taxon?.name||"",scientific_name:obs.taxon?.name||"",iconic_taxon:obs.taxon?.iconic_taxon_name||"",photo_url:obs.photos?.[0]?.url?.replace("square","medium")||null,observed_on:obs.observed_on||"",user_login:obs.user?.login||""});
      }
      if(cb)cb(allObs.length,ci+1,chunks.length);
      if((d.results||[]).length<200)break;pg++;
    }
  }
  return allObs;
}

// ‚îÄ‚îÄ SEASONALITY ‚îÄ‚îÄ
// Build month-of-year histograms from fetched observations (zero additional API calls)
function buildSeasonData(observations) {
  seasonMap = new Map();
  for (const obs of observations) {
    if (!obs.observed_on || !obs.taxon_id) continue;
    const m = new Date(obs.observed_on).getMonth(); // 0-11
    if (!seasonMap.has(obs.taxon_id)) seasonMap.set(obs.taxon_id, new Array(12).fill(0));
    seasonMap.get(obs.taxon_id)[m]++;
  }
  // Determine in-season: has observations in current month ¬± 1
  inSeasonSet = new Set();
  const adj = [(CUR_MONTH + 11) % 12, CUR_MONTH, (CUR_MONTH + 1) % 12];
  for (const [tid, months] of seasonMap) {
    if (adj.some(m => months[m] > 0)) inSeasonSet.add(tid);
  }
}

function isInSeason(taxonId) {
  if (!seasonMap.has(taxonId)) return null; // unknown ‚Äî no obs data
  return inSeasonSet.has(taxonId);
}

function peakMonths(taxonId) {
  const data = seasonMap.get(taxonId);
  if (!data) return "";
  const max = Math.max(...data);
  if (max === 0) return "";
  const peaks = [];
  for (let i = 0; i < 12; i++) {
    if (data[i] >= max * 0.6) peaks.push(MONTH_LABELS[i]);
  }
  return peaks.join("‚Äì");
}

function makeSparkline(taxonId) {
  const data = seasonMap.get(taxonId);
  if (!data) return '<span style="font-size:10px;color:var(--ink-light);font-style:italic">no season data</span>';
  const max = Math.max(...data, 1);
  const bw = 5, gap = 1, h = 20;
  const w = 12 * (bw + gap) - gap;
  let bars = '';
  for (let i = 0; i < 12; i++) {
    const bh = Math.max((data[i] / max) * h, data[i] > 0 ? 2 : 0.5);
    const x = i * (bw + gap);
    const isCur = i === CUR_MONTH;
    const isAdj = i === (CUR_MONTH + 11) % 12 || i === (CUR_MONTH + 1) % 12;
    let fill, opacity;
    if (isCur) { fill = "#4a7c59"; opacity = 1; }
    else if (isAdj) { fill = "#4a7c59"; opacity = 0.4; }
    else { fill = "#c97d3a"; opacity = 0.35; }
    bars += `<rect x="${x}" y="${h-bh}" width="${bw}" height="${bh}" fill="${fill}" opacity="${opacity}" rx="1"/>`;
  }
  // Current month indicator triangle
  const cx = CUR_MONTH * (bw + gap) + bw / 2;
  bars += `<polygon points="${cx-2.5},${h+3} ${cx+2.5},${h+3} ${cx},${h+0.5}" fill="#4a7c59"/>`;
  let months = '';
  for (let i = 0; i < 12; i++) {
    const isCur = i === CUR_MONTH;
    months += `<span style="width:${bw + gap}px;${isCur ? 'color:var(--moss);font-weight:700' : ''}">${MONTH_LABELS[i]}</span>`;
  }
  return `<div class="sparkline-wrap"><svg width="${w}" height="${h+5}" viewBox="0 0 ${w} ${h+5}">${bars}</svg></div><div class="sparkline-months" style="width:${w}px">${months}</div>`;
}

function seasonBadgeHtml(taxonId) {
  const s = isInSeason(taxonId);
  if (s === null) return '<span class="season-badge unknown">? season</span>';
  if (s) {
    const pk = peakMonths(taxonId);
    return `<span class="season-badge in">‚óè now${pk ? ' ¬∑ peak ' + pk : ''}</span>`;
  }
  const pk = peakMonths(taxonId);
  return `<span class="season-badge off">‚óã off season${pk ? ' ¬∑ peak ' + pk : ''}</span>`;
}

// ‚îÄ‚îÄ PLACES NEARBY ‚îÄ‚îÄ
async function fetchNearbyPlaces(lat,lng){
  const d=0.15;
  const data=await inatGet("/places/nearby",{nelat:(lat+d).toFixed(4),nelng:(lng+d).toFixed(4),swlat:(lat-d).toFixed(4),swlng:(lng-d).toFixed(4)});
  const places=[],seen=new Set();
  for(const p of(data?.results?.standard||[])){if(seen.has(p.id))continue;const al=p.admin_level;if(al!==null&&al!==undefined&&al<=10)continue;if(p.bbox_area&&p.bbox_area>25)continue;seen.add(p.id);places.push({...p,_src:"std"})}
  for(const p of(data?.results?.community||[])){if(seen.has(p.id))continue;if(p.bbox_area&&p.bbox_area>10)continue;seen.add(p.id);places.push({...p,_src:"com"})}
  places.sort((a,b)=>{if(a._src!==b._src)return a._src==="com"?-1:1;return(a.bbox_area||999)-(b.bbox_area||999)});
  return places.slice(0,12);
}
let nearbyDebounce=null;
function triggerNearbyFetch(lat,lng){
  clearTimeout(nearbyDebounce);
  nearbyDebounce=setTimeout(async()=>{const sec=document.getElementById("nearbySection");const chips=document.getElementById("nearbyChips");chips.innerHTML='<div class="nearby-loading">Finding nearby places‚Ä¶</div>';sec.style.display="block";try{renderNearbyChips(await fetchNearbyPlaces(lat,lng))}catch(e){console.error(e);chips.innerHTML='<div class="nearby-loading">Could not load nearby places</div>'}},400);
}
function chipIcon(p){const icons={100:"üå≤",20:"üèî",13:"üèù",9:"üèõ",7:"üèò",1000:"üèò"};if(p._src==="com")return icons[p.place_type]||"üåø";if(p.admin_level===20)return"üèõ";return"üìç"}
function chipType(p){if(p.place_type_name)return p.place_type_name;if(p._src==="std"&&p.admin_level===20)return"County";return p._src==="com"?"Community":""}
function renderNearbyChips(places){const el=document.getElementById("nearbyChips");if(!places||!places.length){el.innerHTML='<div class="nearby-loading">No nearby places found</div>';return}el.innerHTML="";for(const p of places){const b=document.createElement("button");b.className="nearby-chip";const t=chipType(p);b.innerHTML=`<span class="chip-icon">${chipIcon(p)}</span>${p.name}${t?` <span class="chip-type">${t}</span>`:""}`;b.onclick=()=>selectNearbyPlace(p);el.appendChild(b)}}
function selectNearbyPlace(p){setMode("place",null);selectedPlaceId=p.id;selectedPlaceName=p.display_name||p.name;const el=document.getElementById("selectedPlace");el.style.display="flex";el.className="badge badge-place";el.innerHTML=`<span>${chipIcon(p)} ${selectedPlaceName}</span><button class="badge-close" onclick="clearPlace()">‚úï</button>`;showPlaceBoundary(p)}
function showPlaceBoundary(p){if(placeLayer){map.removeLayer(placeLayer);placeLayer=null}const geo=p.geometry_geojson||p.bounding_box_geojson;if(!geo)return;try{placeLayer=L.geoJSON(geo,{style:{color:"#4a7c59",fillColor:"#4a7c59",fillOpacity:0.06,weight:2,dashArray:"6 4"}}).addTo(map);map.fitBounds(placeLayer.getBounds(),{padding:[40,40]})}catch(e){}}

// ‚îÄ‚îÄ MAP ‚îÄ‚îÄ
map=L.map("map",{center:[35.7796,-78.6382],zoom:10,zoomControl:false});
L.control.zoom({position:"topright"}).addTo(map);
L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}",{attribution:'Tiles &copy; Esri &mdash; Sources: Esri, HERE, Garmin, USGS, NGA',maxZoom:19}).addTo(map);
obsCluster=L.markerClusterGroup({maxClusterRadius:45,spiderfyOnMaxZoom:true,showCoverageOnHover:false,
  iconCreateFunction:c=>{const n=c.getChildCount(),sz=n<20?32:n<100?38:44;return L.divIcon({html:`<div style="width:${sz}px;height:${sz}px;line-height:${sz}px;border-radius:50%;background:var(--amber);color:#fff;text-align:center;font-size:12px;font-weight:600;font-family:'DM Sans',sans-serif;border:2px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,0.3)">${n>999?Math.round(n/1000)+'k':n}</div>`,className:"",iconSize:[sz,sz]})}
});
map.addLayer(obsCluster);

map.on("click",e=>{
  if(mode!=="radius")return;
  document.getElementById("lat").value=e.latlng.lat.toFixed(5);
  document.getElementById("lng").value=e.latlng.lng.toFixed(5);
  drawCircle();triggerNearbyFetch(e.latlng.lat,e.latlng.lng);
  document.getElementById("tapHint").classList.remove("visible");
});
document.getElementById("radius").addEventListener("change",drawCircle);
function drawCircle(){
  if(searchCircle)map.removeLayer(searchCircle);
  const lat=parseFloat(document.getElementById("lat").value),lng=parseFloat(document.getElementById("lng").value),r=parseFloat(document.getElementById("radius").value)*1000;
  if(isNaN(lat)||isNaN(lng)||isNaN(r))return;
  searchCircle=L.circle([lat,lng],{radius:r,color:"#4a7c59",fillColor:"#4a7c59",fillOpacity:0.08,weight:2,dashArray:"6 4"}).addTo(map);
  map.fitBounds(searchCircle.getBounds(),{padding:[40,40]});
}

const TC={Aves:"#e05252",Mammalia:"#d97b28",Reptilia:"#7aba4f",Amphibia:"#3bb3a0",Actinopterygii:"#4a90d9",Insecta:"#d4a024",Arachnida:"#9b59b6",Mollusca:"#8e6d4a",Plantae:"#3a9945",Fungi:"#c0392b",Chromista:"#16a085"};
const TE={Aves:"üê¶",Mammalia:"ü¶ä",Reptilia:"ü¶é",Amphibia:"üê∏",Actinopterygii:"üêü",Insecta:"ü™≤",Arachnida:"üï∑",Mollusca:"üêå",Plantae:"üåø",Fungi:"üçÑ",Animalia:"üêæ",Chromista:"üî¨"};

function buildMarkerForObs(o) {
  const col = TC[o.iconic_taxon] || "#c97d3a";
  const icon = L.divIcon({ className: "", html: `<div class="obs-marker" style="background:${col}"></div>`, iconSize: [12, 12], iconAnchor: [6, 6] });
  const m = L.marker([o.lat, o.lng], { icon });
  const ph = o.photo_url ? `<img src="${o.photo_url}" alt="${o.common_name}" onerror="this.style.display='none'">` : "";
  const ds = o.observed_on ? new Date(o.observed_on).toLocaleDateString("en-US", { year: "numeric", month: "short", day: "numeric" }) : "";
  m.bindPopup(`<div class="obs-popup">${ph}<div class="obs-meta"><div class="obs-common">${o.common_name}</div><div class="obs-sci">${o.scientific_name}</div>${ds ? `<div class="obs-date">üìÖ ${ds}</div>` : ""}<div class="obs-user">üì∑ ${o.user_login}</div></div><a class="obs-link" href="https://www.inaturalist.org/observations/${o.id}" target="_blank" rel="noopener">View on iNaturalist ‚Üí</a></div>`, { maxWidth: 260, minWidth: 240 });
  return m;
}

function addObsToMap(obs, filterSeason) {
  obsCluster.clearLayers();
  obsByTaxon = new Map();
  let mapped = 0;
  for (const o of obs) {
    if (!obsByTaxon.has(o.taxon_id)) obsByTaxon.set(o.taxon_id, []);
    obsByTaxon.get(o.taxon_id).push(o);
    // Filter by season if toggle is on
    if (filterSeason) {
      const s = isInSeason(o.taxon_id);
      if (s === false) continue; // skip confirmed off-season
    }
    obsCluster.addLayer(buildMarkerForObs(o));
    mapped++;
  }
  const badge = document.getElementById("mapBadge");
  badge.textContent = `üó∫ ${mapped.toLocaleString()} observations mapped${filterSeason ? ' (in season)' : ''}`;
  badge.classList.add("visible");
}

function rebuildMap() {
  addObsToMap(allFetchedObs, seasonFilterOn);
}

let flyToIndex = new Map(); // taxon_id ‚Üí current index
function flyToTaxon(tid) {
  const o = obsByTaxon.get(tid); if (!o || !o.length) return;
  let idx = flyToIndex.get(tid) || 0;
  if (idx >= o.length) idx = 0;
  map.setView([o[idx].lat, o[idx].lng], 16);
  // Open popup for this observation
  obsCluster.eachLayer(layer => {
    if (layer.getLatLng().lat === o[idx].lat && layer.getLatLng().lng === o[idx].lng) {
      layer.openPopup();
    }
  });
  flyToIndex.set(tid, idx + 1);
}

// ‚îÄ‚îÄ SEASON TOGGLE ‚îÄ‚îÄ
function toggleSeason() {
  seasonFilterOn = !seasonFilterOn;
  const btn = document.getElementById("seasonToggle");
  btn.classList.toggle("active", seasonFilterOn);
  rebuildMap();
  updateResultsList();
}

// ‚îÄ‚îÄ SHEET ‚îÄ‚îÄ
function openSheet(){document.getElementById("sheet").classList.add("open");document.getElementById("sheetBackdrop").classList.add("open");if(mode==="radius"&&!document.getElementById("lat").value)document.getElementById("tapHint").classList.add("visible")}
function closeSheet(){document.getElementById("sheet").classList.remove("open");document.getElementById("sheetBackdrop").classList.remove("open");document.getElementById("tapHint").classList.remove("visible")}
function setMode(m,btn){mode=m;document.querySelectorAll(".mode-toggle button").forEach(b=>b.classList.remove("active"));(btn||document.querySelector(`[data-mode="${m}"]`))?.classList.add("active");document.getElementById("radiusFields").style.display=m==="radius"?"block":"none";document.getElementById("placeFields").style.display=m==="place"?"block":"none"}
function useMyLocation(){if(!navigator.geolocation)return alert("Geolocation not available");navigator.geolocation.getCurrentPosition(p=>{document.getElementById("lat").value=p.coords.latitude.toFixed(5);document.getElementById("lng").value=p.coords.longitude.toFixed(5);map.setView([p.coords.latitude,p.coords.longitude],12);drawCircle();triggerNearbyFetch(p.coords.latitude,p.coords.longitude)},()=>alert("Could not get location"),{enableHighAccuracy:true})}

// ‚îÄ‚îÄ AUTOCOMPLETE ‚îÄ‚îÄ
let plT;
document.getElementById("placeSearch").addEventListener("input",e=>{clearTimeout(plT);const q=e.target.value.trim();if(q.length<2){document.getElementById("placeResults").classList.remove("visible");return}plT=setTimeout(()=>doSP(q),300)});
async function doSP(q){try{const d=await inatGet("/places/autocomplete",{q,per_page:8});const l=document.getElementById("placeResults");l.innerHTML="";(d.results||[]).forEach(p=>{const div=document.createElement("div");div.className="ac-item";div.innerHTML=`<div><div class="ac-name">${p.display_name||p.name}</div>${p.place_type_name?`<div class="ac-sub">${p.place_type_name}</div>`:""}</div>`;div.onclick=()=>selectPlace(p);l.appendChild(div)});l.classList.toggle("visible",(d.results||[]).length>0)}catch(e){console.error(e)}}
function selectPlace(p){selectedPlaceId=p.id;selectedPlaceName=p.display_name||p.name;document.getElementById("placeSearch").value="";document.getElementById("placeResults").classList.remove("visible");const el=document.getElementById("selectedPlace");el.style.display="flex";el.className="badge badge-place";el.innerHTML=`<span>üìç ${selectedPlaceName}</span><button class="badge-close" onclick="clearPlace()">‚úï</button>`;showPlaceBoundary(p)}
function clearPlace(){selectedPlaceId=null;selectedPlaceName="";document.getElementById("selectedPlace").style.display="none";if(placeLayer){map.removeLayer(placeLayer);placeLayer=null}}
let txT;
document.getElementById("taxonSearch").addEventListener("input",e=>{clearTimeout(txT);const q=e.target.value.trim();if(q.length<2){document.getElementById("taxonResults").classList.remove("visible");return}txT=setTimeout(()=>doST(q),300)});
async function doST(q){try{const d=await inatGet("/taxa/autocomplete",{q,per_page:8});const l=document.getElementById("taxonResults");l.innerHTML="";(d.results||[]).forEach(t=>{const th=t.default_photo?.square_url||"";const div=document.createElement("div");div.className="ac-item";div.innerHTML=`${th?`<img src="${th}">`:"" }<div><div class="ac-name">${t.preferred_common_name||t.name}</div><div class="ac-sub">${t.name} ¬∑ ${t.rank}</div></div>`;div.onclick=()=>selectTaxon(t);l.appendChild(div)});l.classList.toggle("visible",(d.results||[]).length>0)}catch(e){console.error(e)}}
function selectTaxon(t){
  selectedTaxonId=t.id;selectedTaxonName=t.preferred_common_name||t.name;
  document.getElementById("taxonSearch").value="";document.getElementById("taxonResults").classList.remove("visible");
  const emoji=TE[t.iconic_taxon_name]||"üîç";
  const el=document.getElementById("selectedTaxon");el.style.display="flex";el.className="badge badge-taxon";
  el.innerHTML=`<span>${emoji} ${selectedTaxonName} <i style="color:var(--ink-light)">(${t.name})</i></span><button class="badge-close" onclick="openTaxaBrowser()" title="Change">‚úé</button>`;
  try{localStorage.setItem("nfm_taxon",JSON.stringify({id:t.id,name:selectedTaxonName,emoji}))}catch(e){}
}
function clearTaxon(){selectedTaxonId=null;selectedTaxonName="";document.getElementById("selectedTaxon").style.display="none";try{localStorage.removeItem("nfm_taxon")}catch(e){}}

// ‚îÄ‚îÄ TAXON ID HELPERS ‚îÄ‚îÄ
// selectedTaxonId can be a number or an array of numbers
function taxonIdString(tid) {
  // Convert to comma-separated string for iNat API
  if (Array.isArray(tid)) return tid.join(",");
  return String(tid);
}
async function fetchUserSpeciesIdsMulti(username, tid) {
  // Trees worker takes a single taxonId, so for arrays we call in parallel and merge
  const ids = Array.isArray(tid) ? tid : [tid];
  const results = await Promise.all(ids.map(id => fetchUserSpeciesIds(username, id)));
  const merged = new Set();
  for (const arr of results) for (const id of arr) merged.add(id);
  return [...merged];
}

// ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ
async function runSearch(){
  const username=document.getElementById("username").value.trim();
  if(!username)return alert("Enter your iNaturalist username");
  try{localStorage.setItem("nfm_username",username)}catch(e){}
  const usePlace=selectedPlaceId!=null;
  if(mode==="radius"&&!usePlace&&(!document.getElementById("lat").value||!document.getElementById("lng").value))return alert("Set a location on the map or use GPS");
  if(mode==="place"&&!usePlace)return alert("Select an iNaturalist place");
  closeSheet();
  const taxonId=selectedTaxonId||LIFE_TAXON_ID;
  const d1=getDateFilter();
  seasonFilterOn = true;
  flyToIndex = new Map();
  document.getElementById("seasonToggle").classList.add("active");
  try{
    showLoading(`Fetching your ${selectedTaxonName||""} life list‚Ä¶`);
    const uids=await fetchUserSpeciesIdsMulti(username,taxonId);
    const uset=new Set(uids);
    showLoading(`You've observed ${uset.size.toLocaleString()} species. Scanning area‚Ä¶`);
    const ap={taxon_id:taxonIdString(taxonId),quality_grade:"research,needs_id"};
    if(d1)ap.d1=d1;
    if(usePlace){ap.place_id=selectedPlaceId}else{ap.lat=document.getElementById("lat").value;ap.lng=document.getElementById("lng").value;ap.radius=document.getElementById("radius").value}
    const ad=await fetchAreaSpeciesCounts(ap,(l,t)=>showLoading(`Area species: ${l.toLocaleString()} / ${t.toLocaleString()}‚Ä¶`));
    newForMeSpecies=ad.results.filter(r=>!uset.has(r.taxon.id)).sort((a,b)=>b.count-a.count);

    // Fetch observations
    const topIds=newForMeSpecies.slice(0,200).map(s=>s.taxon.id);
    if(topIds.length>0){
      showLoading(`Mapping observations for ${topIds.length} species‚Ä¶`);
      const op={};
      if(usePlace){op.place_id=selectedPlaceId}else{op.lat=document.getElementById("lat").value;op.lng=document.getElementById("lng").value;op.radius=document.getElementById("radius").value}
      allFetchedObs=await fetchObservationsForTaxa(topIds,op,d1,(c,cd,ct)=>showLoading(`Loading observations: ${c.toLocaleString()} (batch ${cd}/${ct})‚Ä¶`));

      // Build seasonality from observations
      showLoading("Analyzing seasonality‚Ä¶");
      buildSeasonData(allFetchedObs);

      // Sort: in-season first, then by obs count
      newForMeSpecies.sort((a,b)=>{
        const sa=isInSeason(a.taxon.id), sb=isInSeason(b.taxon.id);
        // in-season (true/null) before off-season (false)
        if(sa!==false && sb===false) return -1;
        if(sa===false && sb!==false) return 1;
        return b.count-a.count;
      });

      addObsToMap(allFetchedObs, true);
    } else {
      allFetchedObs = [];
      buildSeasonData([]);
    }

    displayResults(uset.size,ad.results.length);
  }catch(e){console.error(e);alert("Error: "+e.message)}finally{hideLoading()}
}

// ‚îÄ‚îÄ RESULTS ‚îÄ‚îÄ
function displayResults(uc,at){
  const inCount = newForMeSpecies.filter(sp => isInSeason(sp.taxon.id) !== false).length;
  const offCount = newForMeSpecies.length - inCount;
  document.getElementById("resultCount").textContent = newForMeSpecies.length.toLocaleString();
  document.getElementById("resultLabel").innerHTML = `species here new for you<br><span style="opacity:0.5;font-size:11px">${at.toLocaleString()} in area ¬∑ ${uc.toLocaleString()} on your list</span>`;
  document.getElementById("resultsBar").classList.add("visible");
  document.getElementById("resultsFilters").style.display = "flex";
  document.getElementById("filterInfo").textContent = `${inCount} in season ¬∑ ${offCount} off`;
  updateResultsList();
}

function updateResultsList() {
  const el = document.getElementById("resultsList");
  el.innerHTML = "";
  const filtered = seasonFilterOn
    ? newForMeSpecies.filter(sp => isInSeason(sp.taxon.id) !== false)
    : newForMeSpecies;

  filtered.forEach(sp => {
    const t = sp.taxon, th = t.default_photo?.square_url, cn = t.preferred_common_name || t.name, em = TE[t.iconic_taxon_name] || "üîç";
    const offClass = isInSeason(t.id) === false ? " off-season" : "";
    const card = document.createElement("div");
    card.className = "species-card" + offClass;
    card.innerHTML = `
      ${th ? `<img src="${th}" alt="${cn}" loading="lazy">` : `<div class="placeholder-thumb">${em}</div>`}
      <div class="species-info">
        <div class="common">${cn}</div>
        <div class="scientific">${t.name}</div>
        <div class="meta-row">
          <span class="obs-count">${sp.count.toLocaleString()} obs</span>
          ${seasonBadgeHtml(t.id)}
        </div>
        ${makeSparkline(t.id)}
      </div>
      <div class="fly-to" title="Zoom to observations">üìç</div>`;
    card.querySelector(".species-info").onclick = () => window.open(`https://www.inaturalist.org/taxa/${t.id}`, "_blank");
    card.querySelector("img, .placeholder-thumb")?.addEventListener("click", () => window.open(`https://www.inaturalist.org/taxa/${t.id}`, "_blank"));
    card.querySelector(".fly-to").onclick = e => { e.stopPropagation(); flyToTaxon(t.id); if (window.innerWidth < 640) { document.getElementById("resultsList").classList.remove("expanded"); document.getElementById("chevron").classList.remove("up") } };
    el.appendChild(card);
  });
}

function toggleResults(){document.getElementById("resultsList").classList.toggle("expanded");document.getElementById("chevron").classList.toggle("up")}
function clearResults(){
  document.getElementById("resultsBar").classList.remove("visible");
  document.getElementById("resultsFilters").style.display="none";
  document.getElementById("resultsList").innerHTML="";
  document.getElementById("mapBadge").classList.remove("visible");
  obsCluster.clearLayers();obsByTaxon=new Map();newForMeSpecies=[];allFetchedObs=[];seasonMap=new Map();inSeasonSet=new Set();flyToIndex=new Map();
}
function showLoading(m){document.getElementById("loadingText").textContent=m;document.getElementById("loading").classList.add("visible")}
function hideLoading(){document.getElementById("loading").classList.remove("visible")}

document.addEventListener("click",e=>{
  if(!e.target.closest("#placeSearch")&&!e.target.closest("#placeResults"))document.getElementById("placeResults").classList.remove("visible");
  if(!e.target.closest("#taxonSearch")&&!e.target.closest("#taxonResults"))document.getElementById("taxonResults").classList.remove("visible");
});
try{const su=localStorage.getItem("nfm_username");if(su)document.getElementById("username").value=su}catch(e){}
// If taxon is saved, go straight to sheet; otherwise show taxa browser
if (loadSavedTaxon()) {
  setTimeout(openSheet, 400);
} else {
  setTimeout(openTaxaBrowser, 400);
}
</script>
</body>
</html>
